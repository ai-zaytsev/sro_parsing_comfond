# Скрипт для суммирования взносов в компенсационный фонд СРО

В этом репозитории находится асинхронный скрипт на Python, который получает и суммирует значения компенсационного фонда (ООД) саморегулируемых организаций (СРО) из реестров НОПРИЗ и НОСТРОЙ.

## Содержание

- [Возможности](#возможности)
- [Требования](#требования)
- [Установка](#установка)
- [Настройка](#настройка)
- [Использование](#использование)
- [Структура скрипта](#структура-скрипта)
- [Участие в развитии](#участие-в-развитии)
- [Лицензия](#лицензия)

## Возможности

- **Асинхронные запросы**: использует `aiohttp` и `asyncio` для высокопараллельных HTTP POST-запросов.
- **Параллельная загрузка страниц**: настраиваемые семафоры ограничивают количество одновременных запросов страниц и списков участников.
- **Поддержка реестров**: получение данных одновременно из API НОПРИЗ и НОСТРОЙ.
- **Вывод в CSV**: результаты сохраняются в `result.csv`.

## Требования

- Python 3.8 и выше
- Пакеты:
  - `aiohttp`
  - `certifi`

Установка зависимостей:

```bash
pip install -r requirements.txt
```

## Установка

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/yourusername/sro-compfund-sum.git
   cd sro-compfund-sum
   ```
2. (Опционально) Создайте и активируйте виртуальное окружение:
   ```bash
   python -m venv venv
   source venv/bin/activate   # Linux/macOS
   venv\Scripts\activate  # Windows
   ```
3. Установите зависимости из файла `requirements.txt`:
   ```bash
   pip install -r requirements.txt
   ```

## Настройка

Основные параметры находятся в начале файла `main.py`:

| Константа              | Описание                                                         | Значение по умолчанию |
|------------------------|------------------------------------------------------------------|-----------------------|
| `PAGE_SIZE`            | Количество элементов на одной странице запроса к API.            | 100                   |
| `PAGE_CONCURRENCY`     | Максимальное число параллельных запросов страниц.                | 100                   |
| `MEMBER_CONCURRENCY`   | Максимальное число параллельных задач суммирования участников.   | 50                    |

При необходимости измените эти значения.

## Использование

Запустите скрипт с одним из режимов (по умолчанию `both`):

```bash
python main.py [mode]
```

Где `[mode]` может быть:

- `nopriz` — только реестр НОПРИЗ
- `nostroy` — только реестр НОСТРОЙ
- `both` — оба реестра (по умолчанию)

### Результат

Скрипт создаёт (или перезаписывает) файл `result.csv` в каталоге скрипта с колонками:

- `registration_number` — регистрационный номер СРО
- `short_description` — краткое описание или название
- `compfund_fee_odo_sum` — целочисленная сумма взносов в компенсационный фонд

Пример файла CSV:

```csv
registration_number,short_description,compfund_fee_odo_sum
12345,Пример СРО,1500000
67890,Другое СРО,230000
```

## Структура скрипта

1. **fetch**: отправляет POST-запрос и возвращает JSON, при ошибках генерируется исключение.
2. **get_nopriz_sro_items** / **get_nostroy_sro_items**: получает список СРО и их идентификаторов.
3. **sum_for_one_page**: загружает одну страницу списка участников и суммирует поля `compensation_fund`.
4. **compute_sro**: координирует суммирование по всем страницам для одного СРО.
5. **main**: парсит режим, инициализирует CSV, настраивает SSL и сессию, собирает все СРО и записывает результаты пачками.

## Участие в развитии

Буду рад вашим правкам, проблемам и запросам на новые функции:

1. Форкните репозиторий
2. Создайте ветку для фичи (`git checkout -b feature/...`)
3. Сделайте коммиты (`git commit -am 'Добавить фичу'`)
4. Отправьте ветку (`git push origin feature/...`)
5. Откройте Pull Request

## Лицензия

Проект распространяется под лицензией MIT. Подробности в файле [LICENSE](LICENSE).
